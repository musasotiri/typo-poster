<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Poster Generator v1.8.2</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: row;
            height: 100vh;
            width: 100vw;
            background-color: #f8f9fa;
            font-family: 'Inter', sans-serif;
        }

        .left {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0.5rem;
            padding-top: 1rem;
        }

        .right {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #input-panel {
            width: 80%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        #input-and-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            width: 100%;
        }

        #input-container {
            position: relative;
            flex-grow: 1;
        }

        #message {
            width: 100%;
            padding: 0.75rem 3.5rem 0.75rem 0.75rem;
            font-size: 1rem;
            border-radius: 999px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            font-family: inherit;
        }

        #char-counter {
            width: 100%;
            text-align: left;
            font-size: 0.8rem;
            color: #666;
            margin-top: -0.5rem;
        }

        #generate-btn {
            position: absolute;
            right: 3px;
            top: 50%;
            transform: translateY(-50%);
            padding: 0.5rem;
            background: #2176FF;
            color: #fff;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            font-size: 1rem;
            line-height: 0;
        }

        #refresh-btn {
            background: none;
            color: #343a40;
            border: none;
            cursor: pointer;
            font-size: 1rem;
        }

        #poster canvas {
            border: 10px solid white;
            box-shadow: 0 8px 16px rgba(52, 58, 64, 0.2);
        }

        @media(max-width: 768px) {
            body {
                flex-direction: column;
            }

            .left,
            .right {
                flex: none;
                height: 50%;
                width: 100%;
                order: 2;
            }

            .right {
                order: 1;
                padding-top: 0.5rem;
            }

            #input-panel {
                width: 90%;
            }
        }
    </style>
</head>

<body>
    <div class="left">
        <div id="poster"></div>
    </div>
    <div class="right">
        <div id="input-panel">
            <div id="input-and-controls">
                <div id="input-container">
                    <input type="text" id="message" maxlength="60" placeholder="Type your message here..." />
                    <button id="generate-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="lucide lucide-arrow-right">
                            <path d="M5 12h14" />
                            <path d="m12 5 7 7-7 7" />
                        </svg>
                    </button>
                </div>
                <button id="refresh-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-rotate-ccw">
                        <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
                        <path d="M3 3v5h5" />
                    </svg>
                </button>
            </div>
            <div id="char-counter">0/60</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script>
        let Engine = Matter.Engine,
            World = Matter.World,
            Bodies = Matter.Bodies;

        let engine, world;
        let words = [];
        let inputField, generateButton, refreshButton, charCounter;
        let started = false;
        let lastMessage = "";

        // Separate colors into light and dark groups for high contrast
        const lightColors = ['#f1faee', '#a8dadc'];
        const darkColors = ['#e63946', '#457b9d', '#1d3557'];
        const lightTextColor = '#1d3557';
        const darkTextColor = '#f1faee';

        let backgroundColor, wordColor, textColor;

        function setup() {
            let canvasWidth, canvasHeight;
            const aspectRatio = Math.sqrt(2);

            if (window.innerWidth > window.innerHeight) {
                // Landscape mode
                canvasHeight = window.innerHeight * 0.9;
                canvasWidth = canvasHeight / aspectRatio;
            } else {
                // Portrait mode
                canvasWidth = window.innerWidth * 0.9;
                canvasHeight = canvasWidth * aspectRatio;
            }

            let canvas = createCanvas(canvasWidth, canvasHeight);
            canvas.parent('poster');
            engine = Engine.create();
            world = engine.world;
            Engine.run(engine);

            // Ground and walls
            let ground = Bodies.rectangle(width / 2, height + 50, width, 100, {
                isStatic: true
            });
            let leftWall = Bodies.rectangle(-50, height / 2, 100, height, {
                isStatic: true
            });
            let rightWall = Bodies.rectangle(width + 50, height / 2, 100, height, {
                isStatic: true
            });
            World.add(world, [ground, leftWall, rightWall]);

            inputField = document.getElementById("message");
            generateButton = document.getElementById("generate-btn");
            refreshButton = document.getElementById("refresh-btn");
            charCounter = document.getElementById("char-counter");

            generateButton.addEventListener("click", generatePoster);
            refreshButton.addEventListener("click", refreshPoster);
            inputField.addEventListener("keypress", function (e) {
                if (e.key === "Enter") generatePoster();
            });
            inputField.addEventListener("input", function () {
                updateCharCount();
            });

            // Set initial random high-contrast colors
            setHighContrastColors();
        }

        function windowResized() {
            let canvasWidth, canvasHeight;
            const aspectRatio = Math.sqrt(2);

            if (window.innerWidth > window.innerHeight) {
                // Landscape mode
                canvasHeight = window.innerHeight * 0.9;
                canvasWidth = canvasHeight / aspectRatio;
            } else {
                // Portrait mode
                canvasWidth = window.innerWidth * 0.9;
                canvasHeight = canvasWidth * aspectRatio;
            }

            resizeCanvas(canvasWidth, canvasHeight);
            // Recreate walls and ground for new canvas dimensions
            World.clear(world, false); // Clear only bodies, not engine
            let ground = Bodies.rectangle(width / 2, height + 50, width, 100, { isStatic: true });
            let leftWall = Bodies.rectangle(-50, height / 2, 100, height, { isStatic: true });
            let rightWall = Bodies.rectangle(width + 50, height / 2, 100, height, { isStatic: true });
            World.add(world, [ground, leftWall, rightWall]);
            if (lastMessage.length > 0) {
                createWords(lastMessage);
            }
        }

        function updateCharCount() {
            charCounter.textContent = `${inputField.value.length}/60`;
        }

        function generatePoster() {
            lastMessage = inputField.value.trim();
            if (lastMessage.length === 0) return;

            createWords(lastMessage);
            started = true;
            inputField.value = "";
            updateCharCount();
        }

        function refreshPoster() {
            if (lastMessage.length > 0) {
                createWords(lastMessage);
                started = true;
            }
        }

        function setHighContrastColors() {
            const isLightTheme = random() > 0.5;
            if (isLightTheme) {
                backgroundColor = random(lightColors);
                wordColor = random(darkColors);
                textColor = darkTextColor;
            } else {
                backgroundColor = random(darkColors);
                wordColor = random(lightColors);
                textColor = lightTextColor;
            }
        }

        function createWords(msg) {
            // Remove previous word bodies from the world
            if (words.length > 0) {
                for (let i = 0; i < words.length; i++) {
                    World.remove(world, words[i].body);
                }
            }
            words = []; // Clear the visual array for new words

            // Select new random colors
            setHighContrastColors();

            // New rule: Add a space after punctuation that is not followed by a space,
            // then split by whitespace. This correctly separates words like "hello,world"
            const processedMsg = msg.replace(/([.,!?;:])(?=\S)/g, '$1 ');
            let parts = processedMsg.trim().split(/\s+/).filter(Boolean);

            if (parts.length === 0) return;

            // New rule: Merge two words based on a random condition if total words > 7
            if (parts.length > 7) {
                let mergedParts = [];
                let i = 0;
                while (i < parts.length) {
                    // 50% chance of merging
                    const shouldMerge = random() < 0.5;

                    if (shouldMerge && i + 1 < parts.length) {
                        mergedParts.push(parts[i] + ' ' + parts[i + 1]);
                        i += 2; // Skip the next word
                    } else {
                        mergedParts.push(parts[i]);
                        i += 1; // Move to the next word
                    }
                }
                parts = mergedParts;
            }

            // Convert all words to uppercase
            parts = parts.map(word => word.toUpperCase());

            let longestWord = parts.reduce((longest, current) => current.length > longest.length ? current : longest, "");

            let baseFontSize = height * 0.35;
            let targetTextWidth = width * 0.9;

            textSize(baseFontSize);
            let tempTextWidth = textWidth(longestWord);

            let adjustedFontSize = baseFontSize;

            if (tempTextWidth > targetTextWidth) {
                adjustedFontSize = baseFontSize * (targetTextWidth / tempTextWidth);
            }

            // New rule: Reduce font size by 50% if there are 7 or more words.
            if (parts.length >= 7) {
                adjustedFontSize *= 0.6; // 100% - 50% = 50%
            } else {
                adjustedFontSize *= 0.9; // Otherwise, use the previous 25% reduction
            }

            adjustedFontSize = max(adjustedFontSize, 40);

            // FILO order â†’ reverse
            parts.reverse().forEach((w, i) => {
                let x = width / 2 + random(-50, 50);
                let y = -200 - i * (adjustedFontSize * 1.5);
                words.push(new Word(w, x, y, adjustedFontSize, wordColor, textColor));
            });
        }

        function draw() {
            background(backgroundColor);

            if (started) {
                for (let w of words) {
                    w.show();
                }
            }
        }

        class Word {
            constructor(word, x, y, fontSize, color, textColor) {
                this.word = word;
                this.fontSize = fontSize;
                this.color = color;
                this.textColor = textColor;
                textSize(this.fontSize);
                this.textWidth = textWidth(word);

                // Visual padding for the background rectangle
                const visualPaddingX = 30; // 15px left & right
                const visualPaddingY = 10; // 10px top & 0px bottom

                // Invisible physics blocks are 2px bigger on all sides
                const physicsPadding = 4; // 2px on each side

                const blockWidth = this.textWidth + visualPaddingX + physicsPadding;
                const blockHeight = this.fontSize + visualPaddingY + physicsPadding;

                this.body = Bodies.rectangle(x, y, blockWidth, blockHeight, {
                    restitution: 0.2,
                    friction: 0.8,
                    angle: random(-PI / 4, PI / 4)
                });
                World.add(world, this.body);
            }

            show() {
                let pos = this.body.position;
                this.body.angle = constrain(this.body.angle, -PI / 4, PI / 4);
                let angle = this.body.angle;

                push();
                translate(pos.x, pos.y);
                rotate(angle);

                rectMode(CENTER);
                noStroke();
                fill(this.color);

                // Updated: Visual rectangle with padding
                const visualPaddingX = 30;
                const visualPaddingY = 10;
                rect(0, 0, this.textWidth + visualPaddingX, this.fontSize + visualPaddingY);

                fill(this.textColor); // Use the dynamically selected text color
                textAlign(CENTER, CENTER);
                textSize(this.fontSize);
                text(this.word, 0, 5);

                pop();
            }
        }
    </script>
</body>

</html>